<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Double Jeu</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400;1,600&family=IBM+Plex+Mono:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
:root {
  --bg:           #080808;
  --bg-raised:    #0e0e0e;
  --bg-card:      #111111;
  --bg-overlay:   rgba(8,8,8,0.96);
  --text-primary: #ddd8cc;
  --text-secondary:#8a8478;
  --text-muted:   #4a4640;
  --border:       #222018;
  --border-mid:   #3a3630;
  --border-active:#6a6050;
  --accent:       #c8b07a;
  --accent-dim:   #6b5e3f;
  --accent-glow:  rgba(200,176,122,0.12);
  --danger:       #9b4040;
  --danger-dim:   #5a2525;
  --danger-glow:  rgba(155,64,64,0.15);
  --good:         #3d6b50;
  --good-bright:  #70b888;
  --surreal:      #4a3a6a;
  --surreal-bright:#a878d8;

  /* ── Couleurs par stat (toutes distinctes) ── */
  --c-energie:    #d4914a;   /* orange brûlé     */
  --c-moral:      #6a9ec0;   /* bleu acier        */
  --c-relations:  #70b888;   /* vert sauge        */
  --c-reputation: #c8b07a;   /* or/crème (accent) */
  --c-stress:     #b05090;   /* rose fuchsia      */
  --c-argent:     #a0b870;   /* vert kaki         */
  --c-avancement: #c8b07a;   /* or (même qu'accent) */
  --c-temps:      #8090b8;   /* bleu ardoise      */
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;background:var(--bg);}
body{color:var(--text-primary);font-family:'IBM Plex Mono',monospace;font-size:0.82rem;line-height:1.7;overflow:hidden;}
@media(max-width:640px){body{overflow-y:auto;}}

/* ── NOISE OVERLAY ── */
body::before{
  content:'';
  position:fixed;inset:0;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events:none;z-index:1000;opacity:0.35;
}

/* ── START SCREEN ── */
#start-screen{
  position:fixed;inset:0;
  background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:28px;z-index:500;padding:32px;
  transition:opacity 600ms ease;
}
#start-screen.fade-out{opacity:0;pointer-events:none;}
#start-screen.hidden{display:none;}

.start-eyebrow{
  font-family:'IBM Plex Mono',monospace;
  font-size:0.6rem;letter-spacing:0.4em;text-transform:uppercase;
  color:var(--text-muted);
}
.start-title{
  font-family:'Cormorant Garamond',serif;
  font-weight:300;font-size:4.5rem;
  letter-spacing:0.06em;line-height:1.1;
  color:var(--accent);text-align:center;
}
.start-title em{font-style:italic;color:var(--text-secondary);}
.start-rule{width:120px;height:1px;background:var(--border-mid);}
.start-tagline{
  font-family:'Cormorant Garamond',serif;
  font-style:italic;font-size:1.1rem;
  color:var(--text-secondary);text-align:center;
  max-width:420px;line-height:1.8;
}
.start-desc{
  max-width:460px;text-align:center;
  color:var(--text-muted);font-size:0.75rem;
  line-height:1.9;letter-spacing:0.02em;
}
.btn-start{
  font-family:'IBM Plex Mono',monospace;
  font-size:0.65rem;letter-spacing:0.3em;text-transform:uppercase;
  padding:14px 44px;
  background:transparent;cursor:pointer;
  border:1px solid var(--accent-dim);color:var(--accent);
  transition:all 300ms ease;margin-top:8px;
  position:relative;overflow:hidden;
}
.btn-start::before{
  content:'';position:absolute;inset:0;
  background:var(--accent-glow);opacity:0;
  transition:opacity 300ms;
}
.btn-start:hover::before{opacity:1;}
.btn-start:hover{border-color:var(--accent);transform:translateY(-2px);}

@media(max-width:640px){
  .start-title{font-size:2.8rem;}
}

/* ── LAYOUT ── */
#game{
  display:grid;
  grid-template-rows:auto 1fr auto;
  height:100vh;
  max-width:1060px;margin:0 auto;
}

/* ── TOPBAR ── */
#topbar{
  border-bottom:1px solid var(--border);
  padding:10px 20px;
  display:flex;justify-content:space-between;align-items:center;
  background:var(--bg-raised);
  gap:12px;flex-wrap:wrap;
}
.game-title{
  font-family:'Cormorant Garamond',serif;
  font-weight:300;font-size:1.15rem;
  letter-spacing:0.1em;color:var(--accent);
  white-space:nowrap;flex-shrink:0;
}
.game-title span{
  font-family:'IBM Plex Mono',monospace;
  font-size:0.6rem;letter-spacing:0.25em;
  color:var(--text-muted);display:block;
  margin-top:1px;
}
.stats-row{display:flex;gap:16px;align-items:center;flex-wrap:wrap;}
.stat{
  display:flex;flex-direction:column;align-items:center;gap:1px;
  position:relative;cursor:help;
}
/* Stat tooltip */
.stat::after{
  content:attr(data-tip);
  position:absolute;
  top:calc(100% + 10px);
  left:50%;transform:translateX(-50%);
  background:#0e0e0e;
  border:1px solid var(--border-mid);
  color:var(--text-secondary);
  font-size:0.62rem;line-height:1.6;
  padding:8px 12px;
  width:200px;
  pointer-events:none;
  opacity:0;
  transition:opacity 200ms;
  z-index:300;
  letter-spacing:0.02em;
  font-style:italic;
  text-align:center;
}
.stat:hover::after{opacity:1;}
.stat-label{font-size:0.55rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--text-muted);}
.stat-val{font-size:0.85rem;font-weight:500;color:var(--text-primary);}
.stat-val.danger{color:#cc4444;}
.stat-val.warn{color:#c8a040;}
.stat-val.good{color:var(--c-relations);}
/* Per-stat accent colors in topbar */
.stat[data-stat="energie"] .stat-val { color: var(--c-energie); }
.stat[data-stat="moral"]   .stat-val { color: var(--c-moral); }
.stat[data-stat="relations"] .stat-val { color: var(--c-relations); }
.stat[data-stat="reputation"] .stat-val { color: var(--c-reputation); }
.stat[data-stat="stress"]  .stat-val { color: var(--c-stress); }
.stat[data-stat="argent"]  .stat-val { color: var(--c-argent); }
.day-badge{
  font-size:0.6rem;letter-spacing:0.2em;
  color:var(--text-muted);border:1px solid var(--border);
  padding:4px 10px;white-space:nowrap;flex-shrink:0;
}

/* ── MAIN ── */
#main{
  display:grid;
  grid-template-columns:1fr 300px;
  overflow:hidden;
  gap:0;
}
#left-panel{overflow-y:auto;padding:20px 20px 20px 24px;border-right:1px solid var(--border);}
#right-panel{overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px;}

/* ── MOBILE LAYOUT ── */
@media(max-width:760px){
  html,body{height:auto;}
  body{overflow-y:auto;overflow-x:hidden;}
  #game{
    height:auto;min-height:100vh;
    grid-template-rows:auto auto auto auto;
  }
  #topbar{
    padding:10px 14px;
    flex-direction:column;align-items:flex-start;
    gap:10px;
  }
  .stats-row{
    gap:10px;width:100%;
    display:grid;
    grid-template-columns:repeat(3,1fr);
  }
  .stat{
    background:var(--bg-card);
    border:1px solid var(--border);
    padding:6px 8px;
    border-radius:0;
    align-items:flex-start;
  }
  /* On mobile, tooltip appears above */
  .stat::after{
    top:auto;
    bottom:calc(100% + 8px);
    font-size:0.6rem;
    width:180px;
  }
  .game-title{font-size:1rem;}
  #main{
    grid-template-columns:1fr;
    overflow:visible;
    display:flex;flex-direction:column;
  }
  #left-panel{
    border-right:none;
    border-bottom:1px solid var(--border);
    overflow:visible;
    padding:16px 14px;
  }
  #right-panel{
    overflow:visible;
    padding:14px;
    gap:10px;
  }
  .cards-grid{
    grid-template-columns:repeat(2,1fr);
    gap:8px;
  }
  #bottombar{
    padding:10px 14px;
    flex-wrap:wrap;gap:8px;
  }
  .btn{padding:10px 14px;font-size:0.58rem;}
  .stat-val{font-size:0.8rem;}
  /* Gauge rows on mobile: bigger touch targets */
  .gauge-row{margin-bottom:12px;}
  .gauge-track{height:6px;}
}

/* ── PHASE HEADER ── */
.phase-header{
  display:flex;align-items:baseline;gap:12px;
  margin-bottom:16px;
}
.phase-num{
  font-size:0.55rem;letter-spacing:0.25em;text-transform:uppercase;
  color:var(--text-muted);border:1px solid var(--border);
  padding:3px 8px;
}
.phase-title{
  font-family:'Cormorant Garamond',serif;
  font-weight:400;font-size:1.4rem;letter-spacing:0.04em;
  color:var(--text-primary);
}

/* ── EVENT CARD ── */
.event-card{
  background:var(--bg-card);
  border:1px solid var(--border-mid);
  padding:18px 20px;
  margin-bottom:20px;
  position:relative;
  animation:fadeUp 400ms ease backwards;
}
.event-card.heavy{
  border-color:var(--danger-dim);
  background:#120a0a;
}
.event-card.surreal{
  border-color:var(--surreal);
  background:#0e0b12;
}
.event-tag{
  font-size:0.52rem;letter-spacing:0.2em;text-transform:uppercase;
  position:absolute;top:12px;right:12px;
  border:1px solid var(--border);color:var(--text-muted);
  padding:2px 7px;
}
.event-tag.heavy{border-color:var(--danger-dim);color:var(--danger);}
.event-tag.surreal{border-color:var(--surreal);color:var(--surreal-bright);}
.event-text{
  font-family:'Cormorant Garamond',serif;
  font-style:italic;font-size:1.05rem;
  color:var(--text-secondary);line-height:1.75;
  padding-right:60px;
  margin-bottom:14px;
}
.event-effects{
  display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;
}
.effect-pill{
  font-size:0.6rem;letter-spacing:0.1em;
  padding:3px 8px;border:1px solid;
}
.effect-pill.neg{border-color:var(--danger-dim);color:var(--danger);}
.effect-pill.pos{border-color:var(--good);color:var(--good-bright);}
.effect-pill.neutral{border-color:var(--border-mid);color:var(--text-muted);}
.event-choices{display:flex;gap:8px;flex-wrap:wrap;}
.btn-choice{
  font-family:'IBM Plex Mono',monospace;
  font-size:0.62rem;letter-spacing:0.15em;
  padding:8px 16px;cursor:pointer;
  background:transparent;border:1px solid var(--border-mid);
  color:var(--text-secondary);
  transition:all 200ms;
}
.btn-choice:hover{border-color:var(--border-active);color:var(--text-primary);}
.btn-choice.acted{opacity:0.4;cursor:default;}

/* ── ACTION CARDS ── */
.section-label{
  font-size:0.55rem;letter-spacing:0.3em;text-transform:uppercase;
  color:var(--text-muted);margin-bottom:12px;
  display:flex;align-items:center;gap:10px;
}
.section-label::after{content:'';flex:1;height:1px;background:var(--border);}
.cards-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
  gap:8px;
  margin-bottom:20px;
}
.action-card{
  background:var(--bg-card);border:1px solid var(--border);
  padding:14px;cursor:pointer;
  transition:all 200ms ease;
  position:relative;
  animation:fadeUp 300ms ease backwards;
}
.action-card:hover{border-color:var(--border-active);background:#161410;}
.action-card.played{opacity:0.3;cursor:default;pointer-events:none;}
.action-card.surreal{border-color:var(--surreal);}
.action-card.surreal:hover{border-color:var(--surreal-bright);}
.card-name{
  font-family:'Cormorant Garamond',serif;
  font-weight:600;font-size:1rem;
  letter-spacing:0.02em;margin-bottom:6px;
  color:var(--text-primary);
}
.card-text{
  font-size:0.72rem;color:var(--text-muted);
  line-height:1.6;margin-bottom:10px;
  font-style:italic;
}
/* ── CARD COSTS & EFFECTS — redesigned ── */
.card-costs{
  display:flex;gap:5px;flex-wrap:wrap;
  margin-bottom:8px;
  padding-bottom:8px;
  border-bottom:1px solid var(--border);
}
.card-effects{
  display:flex;gap:5px;flex-wrap:wrap;
}

/* Base chip */
.chip{
  display:inline-flex;align-items:center;gap:3px;
  font-size:0.58rem;letter-spacing:0.06em;font-weight:500;
  padding:3px 7px;
  border-radius:2px;
  white-space:nowrap;
}

/* Temps chip — toujours en bleu ardoise, jamais rouge */
.chip-temps{
  background:rgba(128,144,184,0.15);
  border:1px solid rgba(128,144,184,0.4);
  color:var(--c-temps);
}

/* Per-stat chips */
.chip-energie{ background:rgba(212,145,74,0.12); border:1px solid rgba(212,145,74,0.35); color:var(--c-energie); }
.chip-moral{   background:rgba(106,158,192,0.12); border:1px solid rgba(106,158,192,0.35); color:var(--c-moral); }
.chip-relations{ background:rgba(112,184,136,0.12); border:1px solid rgba(112,184,136,0.35); color:var(--c-relations); }
.chip-reputation{ background:rgba(200,176,122,0.12); border:1px solid rgba(200,176,122,0.35); color:var(--c-reputation); }
.chip-stress{  background:rgba(176,80,144,0.12); border:1px solid rgba(176,80,144,0.35); color:var(--c-stress); }
.chip-argent{  background:rgba(160,184,112,0.12); border:1px solid rgba(160,184,112,0.35); color:var(--c-argent); }
.chip-avancement{ background:rgba(200,176,122,0.12); border:1px solid rgba(200,176,122,0.35); color:var(--c-avancement); }

/* Sign modifier: loss dims the chip, gain brightens it */
.chip.loss{ opacity:0.75; }
.chip.gain{ opacity:1; }

/* Sign prefix */
.chip-sign{ font-size:0.7rem; line-height:1; margin-right:1px; }

/* Legacy — keep for event pills */
.card-costs .cost-tag,
.card-effects .eff-tag{ display:none; } /* hidden, replaced by chips */
.effect-pill.neg{border-color:var(--danger-dim);color:var(--danger);}
.effect-pill.pos{border-color:var(--good);color:var(--c-relations);}
.effect-pill.neutral{border-color:var(--border-mid);color:var(--text-muted);}
.card-rarete{
  position:absolute;top:8px;right:8px;
  font-size:0.5rem;color:var(--accent-dim);
}
.card-rarete.rare{color:var(--surreal-bright);}

/* ── TIME BAR ── */
.time-bar-container{
  margin-bottom:20px;
  background:var(--bg-card);
  border:1px solid var(--border);
  padding:12px 16px;
}
.time-bar-header{
  display:flex;justify-content:space-between;align-items:baseline;
  margin-bottom:8px;
}
.time-bar-label{font-size:0.55rem;letter-spacing:0.3em;text-transform:uppercase;color:var(--text-muted);}
.time-remaining{font-size:0.82rem;color:var(--accent);}
.time-remaining.warn{color:var(--stress-bright);}
.time-remaining.danger{color:var(--danger);}
.time-slots{display:flex;gap:4px;}
.time-slot{
  height:8px;flex:1;
  background:var(--border);
  transition:background 300ms ease;
}
.time-slot.used{background:var(--border-mid);}
.time-slot.active{background:var(--accent);}
.time-slot.warn{background:var(--stress-bright);}
.time-slot.danger-slot{background:var(--danger);}
.time-exhausted-msg{
  font-size:0.65rem;letter-spacing:0.1em;
  color:var(--danger);margin-top:8px;
  font-style:italic;
}

/* ── TOOLTIP SURRÉALISTE ── */
.surreal-badge{
  font-size:0.52rem;letter-spacing:0.15em;text-transform:uppercase;
  color:var(--surreal-bright);border:1px solid var(--surreal);
  padding:2px 6px;margin-top:6px;display:inline-block;
  position:relative;cursor:help;
}
.surreal-badge::after{
  content:attr(data-tip);
  position:absolute;
  bottom:calc(100% + 8px);
  left:50%;transform:translateX(-50%);
  background:#1a1020;
  border:1px solid var(--surreal);
  color:var(--surreal-bright);
  font-size:0.62rem;line-height:1.6;
  padding:8px 12px;
  width:230px;
  pointer-events:none;
  opacity:0;
  transition:opacity 200ms;
  z-index:200;
  letter-spacing:0.03em;
  font-style:italic;
}
.surreal-badge:hover::after{opacity:1;}

.section-block{background:var(--bg-card);border:1px solid var(--border);padding:14px;}
.block-label{
  font-size:0.55rem;letter-spacing:0.3em;text-transform:uppercase;
  color:var(--text-muted);margin-bottom:12px;
  padding-bottom:8px;border-bottom:1px solid var(--border);
}
.gauge-row{margin-bottom:10px;}
.gauge-name{
  display:flex;justify-content:space-between;
  font-size:0.65rem;letter-spacing:0.1em;margin-bottom:4px;
}
.gauge-name span:first-child{color:var(--text-secondary);}
.gauge-name span:last-child{color:var(--text-primary);}
.gauge-track{
  height:4px;background:var(--border);
  position:relative;overflow:hidden;
}
.gauge-fill{
  height:100%;
  transition:width 400ms ease, background-color 400ms;
}
.gauge-fill.energie{background:var(--c-energie);}
.gauge-fill.moral{background:var(--c-moral);}
.gauge-fill.relations{background:var(--c-relations);}
.gauge-fill.reputation{background:var(--c-reputation);}
.gauge-fill.stress{background:var(--c-stress);}
.gauge-fill.avancement{background:var(--c-avancement);}
/* Critical states */
.gauge-fill.low{background:var(--danger)!important;}
.gauge-fill.mid{background:#b06030!important;}
.gauge-fill.stress.mid{background:#943070!important;}
.gauge-fill.stress.low{background:#cc2288!important;}

/* Gauge tooltips */
.gauge-tip{
  position:relative;cursor:help;
  font-size:0.65rem;color:var(--text-secondary);
}
.gauge-tip::after{
  content:attr(data-tip);
  position:absolute;
  left:0;top:calc(100% + 6px);
  background:#0e0e0e;
  border:1px solid var(--border-mid);
  color:var(--text-secondary);
  font-size:0.6rem;line-height:1.6;
  padding:6px 10px;
  width:200px;
  pointer-events:none;
  opacity:0;
  transition:opacity 200ms;
  z-index:200;
  letter-spacing:0.02em;
  font-style:italic;
}
.gauge-tip:hover::after{opacity:1;}

/* ── LOG ── */
#log{
  flex:1;min-height:120px;max-height:240px;
  overflow-y:auto;
  display:flex;flex-direction:column;gap:3px;
}
.log-entry{
  font-size:0.68rem;letter-spacing:0.04em;
  color:var(--text-muted);line-height:1.5;
  padding:2px 0;border-bottom:1px solid var(--border);
}
.log-entry.success{color:var(--good-bright);}
.log-entry.failure{color:var(--danger);}
.log-entry.surreal{color:var(--surreal-bright);}
.log-entry.warn{color:var(--stress-bright);}
.log-entry.system{color:var(--accent-dim);}

/* ── BOTTOM BAR ── */
#bottombar{
  border-top:1px solid var(--border);
  padding:10px 24px;
  background:var(--bg-raised);
  display:flex;justify-content:space-between;align-items:center;gap:12px;
}
.affaire-bar{
  display:flex;align-items:center;gap:12px;flex:1;
}
.affaire-label{font-size:0.6rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--text-muted);}
.affaire-track{flex:1;height:6px;background:var(--border);position:relative;max-width:200px;}
.affaire-fill{height:100%;background:var(--accent);transition:width 600ms ease;}
.affaire-pct{font-size:0.7rem;color:var(--accent);}
.btn{
  font-family:'IBM Plex Mono',monospace;
  font-size:0.62rem;letter-spacing:0.2em;text-transform:uppercase;
  padding:10px 20px;cursor:pointer;
  background:transparent;border:1px solid var(--border-mid);
  color:var(--text-secondary);
  transition:all 200ms;white-space:nowrap;
}
.btn:hover{border-color:var(--border-active);color:var(--text-primary);}
.btn.primary{border-color:var(--accent-dim);color:var(--accent);}
.btn.primary:hover{background:var(--accent-glow);border-color:var(--accent);}
.btn.danger-btn{border-color:var(--danger-dim);color:var(--danger);}
.btn.danger-btn:hover{background:var(--danger-glow);}

/* ── OVERLAY / MODAL ── */
#overlay{
  position:fixed;inset:0;
  background:var(--bg-overlay);
  display:flex;align-items:center;justify-content:center;
  z-index:400;opacity:0;pointer-events:none;
  transition:opacity 300ms;
}
#overlay.active{opacity:1;pointer-events:all;}
.modal{
  background:var(--bg-raised);
  border:1px solid var(--border-mid);
  max-width:520px;width:90%;
  max-height:80vh;overflow-y:auto;
  padding:28px;
  animation:fadeUp 300ms ease;
}
.modal-title{
  font-family:'Cormorant Garamond',serif;
  font-weight:300;font-size:1.8rem;
  letter-spacing:0.06em;color:var(--accent);
  margin-bottom:8px;
}
.modal-sub{font-size:0.6rem;letter-spacing:0.25em;text-transform:uppercase;color:var(--text-muted);margin-bottom:20px;}
.modal-body{color:var(--text-secondary);font-size:0.8rem;line-height:1.9;margin-bottom:20px;}
.modal-body strong{color:var(--text-primary);}
.result-row{
  display:flex;justify-content:space-between;
  align-items:baseline;padding:6px 0;
  border-bottom:1px solid var(--border);
  font-size:0.8rem;
}
.result-row:last-child{border:none;}
.result-label{color:var(--text-muted);font-size:0.65rem;letter-spacing:0.15em;}
.result-val{color:var(--text-primary);}
.result-val.good{color:var(--good-bright);}
.result-val.bad{color:var(--danger);}

/* ── GAME OVER ── */
#gameover{
  position:fixed;inset:0;
  background:var(--bg-overlay);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:20px;z-index:600;
  opacity:0;pointer-events:none;transition:opacity 800ms;
  text-align:center;padding:32px;
}
#gameover.active{opacity:1;pointer-events:all;}
.go-title{
  font-family:'Cormorant Garamond',serif;
  font-weight:300;font-style:italic;
  font-size:3rem;color:var(--danger);letter-spacing:0.06em;
}
.go-reason{
  font-family:'Cormorant Garamond',serif;
  font-size:1.1rem;color:var(--text-secondary);
  max-width:400px;line-height:1.8;
  font-style:italic;
}
.go-stats{
  background:var(--bg-card);border:1px solid var(--border);
  padding:16px 24px;min-width:280px;
  margin:4px 0;
}

/* ── WIN SCREEN ── */
#winscreen{
  position:fixed;inset:0;
  background:var(--bg-overlay);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:20px;z-index:600;
  opacity:0;pointer-events:none;transition:opacity 800ms;
  text-align:center;padding:32px;
}
#winscreen.active{opacity:1;pointer-events:all;}
.win-title{
  font-family:'Cormorant Garamond',serif;
  font-weight:300;font-size:3rem;color:var(--accent);letter-spacing:0.06em;
}

/* ── ANIMATIONS ── */
@keyframes fadeUp{
  from{opacity:0;transform:translateY(6px);}
  to{opacity:1;transform:translateY(0);}
}
@keyframes pulse{
  0%,100%{opacity:1;}50%{opacity:0.4;}
}
.pulse{animation:pulse 1.5s ease infinite;}

/* ── STAT FLASH ── */
@keyframes flashRed{0%,100%{background:transparent;}50%{background:var(--danger-glow);}}
@keyframes flashGold{0%,100%{background:transparent;}50%{background:var(--accent-glow);}}
.flash-red{animation:flashRed 600ms ease;}
.flash-gold{animation:flashGold 600ms ease;}

/* ── SCROLLBAR ── */
::-webkit-scrollbar{width:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border-mid);}
</style>
</head>
<body>

<!-- START SCREEN -->
<div id="start-screen">
  <div class="start-eyebrow">Un jeu de gestion &amp; survie</div>
  <div class="start-title">Double<br><em>Jeu</em></div>
  <div class="start-rule"></div>
  <div class="start-tagline">Vous êtes enquêteur. L'affaire avance.<br>Votre vie, elle, recule.</div>
  <div class="start-desc">
    Vous avez 8 heures par jour. Pas plus. Chaque action prend du temps — choisissez bien.
    Gérez énergie, moral, relations. Résistez aux événements surréalistes.
    Résolvez l'affaire avant de vous effondrer.
  </div>
  <button class="btn-start" onclick="startGame()">Commencer le jeu</button>
</div>

<!-- GAME -->
<div id="game" style="display:none;">
  <!-- TOPBAR -->
  <div id="topbar">
    <div class="game-title">
      Double Jeu
      <span>Enquête en cours</span>
    </div>
    <div class="stats-row">
      <div class="stat" data-stat="energie" data-tip="Votre carburant physique. Trop faible, vous ne pouvez plus agir. Tombe à 0 — c'est la fin.">
        <div class="stat-label">Énergie</div>
        <div class="stat-val" id="ui-energie">10</div>
      </div>
      <div class="stat" data-stat="moral" data-tip="Votre résistance psychologique. S'effrite sous les coups durs, les sacrifices, les mauvais choix. Tombe à 0 — burn-out.">
        <div class="stat-label">Moral</div>
        <div class="stat-val" id="ui-moral">5</div>
      </div>
      <div class="stat" data-stat="relations" data-tip="Vos liens avec votre famille et vos proches. Chaque heure volée à l'enquête les fragilise. Tombe à 0 — ils sont partis.">
        <div class="stat-label">Relations</div>
        <div class="stat-val" id="ui-relations">7</div>
      </div>
      <div class="stat" data-stat="reputation" data-tip="Votre crédibilité professionnelle. Chaque raccourci, chaque compromis la grignote. Elle influence vos chances de succès.">
        <div class="stat-label">Réputation</div>
        <div class="stat-val" id="ui-reputation">8</div>
      </div>
      <div class="stat" data-stat="stress" data-tip="La pression accumulée. Monte chaque jour, s'emballe avec les coups durs. Atteint 10 — vous craquez.">
        <div class="stat-label">Stress</div>
        <div class="stat-val" id="ui-stress">2</div>
      </div>
      <div class="stat" data-stat="argent" data-tip="Vos liquidités. Le loyer tombe chaque soir. Certaines actions coûtent cher. À sec trop longtemps — c'est la fin.">
        <div class="stat-label">Argent</div>
        <div class="stat-val" id="ui-argent">100€</div>
      </div>
      <div class="day-badge" id="ui-day">Jour 1</div>
    </div>
  </div>

  <!-- MAIN -->
  <div id="main">
    <!-- LEFT PANEL -->
    <div id="left-panel">
      <!-- Phase header -->
      <div class="phase-header">
        <div class="phase-num" id="phase-num">Phase I</div>
        <div class="phase-title" id="phase-title">Événement du jour</div>
      </div>

      <!-- Event -->
      <div id="event-area"></div>

      <!-- Time bar -->
      <div class="time-bar-container" id="time-bar-container">
        <div class="time-bar-header">
          <div class="time-bar-label">Temps disponible aujourd'hui</div>
          <div class="time-remaining" id="time-remaining">8h restantes</div>
        </div>
        <div class="time-slots" id="time-slots"></div>
        <div class="time-exhausted-msg" id="time-exhausted-msg" style="display:none;">
          Journée épuisée. Passez à demain.
        </div>
      </div>

      <!-- Action cards -->
      <div class="section-label">Actions disponibles</div>
      <div class="cards-grid" id="cards-area"></div>

      <!-- Played cards log -->
      <div class="section-label" id="played-label" style="display:none;">Cartes jouées aujourd'hui</div>
      <div class="cards-grid" id="played-area"></div>
    </div>

    <!-- RIGHT PANEL -->
    <div id="right-panel">
      <!-- Gauges -->
      <div class="section-block">
        <div class="block-label">État psychophysique</div>
        <div class="gauge-row" id="g-energie">
          <div class="gauge-name">
            <span class="gauge-tip" data-tip="Carburant physique — tombe à 0, c'est la fin">Énergie ⓘ</span>
            <span id="gv-energie">10/10</span>
          </div>
          <div class="gauge-track"><div class="gauge-fill energie" id="gf-energie" style="width:100%"></div></div>
        </div>
        <div class="gauge-row" id="g-moral">
          <div class="gauge-name">
            <span class="gauge-tip" data-tip="Résistance psychologique — tombe à 0, burn-out">Moral ⓘ</span>
            <span id="gv-moral">5/10</span>
          </div>
          <div class="gauge-track"><div class="gauge-fill moral" id="gf-moral" style="width:50%"></div></div>
        </div>
        <div class="gauge-row" id="g-relations">
          <div class="gauge-name">
            <span class="gauge-tip" data-tip="Liens familiaux et proches — tombe à 0, ils sont partis">Relations ⓘ</span>
            <span id="gv-relations">7/10</span>
          </div>
          <div class="gauge-track"><div class="gauge-fill relations" id="gf-relations" style="width:70%"></div></div>
        </div>
        <div class="gauge-row" id="g-reputation">
          <div class="gauge-name">
            <span class="gauge-tip" data-tip="Crédibilité professionnelle — influence vos chances de succès">Réputation ⓘ</span>
            <span id="gv-reputation">8/10</span>
          </div>
          <div class="gauge-track"><div class="gauge-fill reputation" id="gf-reputation" style="width:80%"></div></div>
        </div>
        <div class="gauge-row" id="g-stress">
          <div class="gauge-name">
            <span class="gauge-tip" data-tip="Pression accumulée — monte chaque jour. Atteint 10, vous craquez">Stress ⓘ</span>
            <span id="gv-stress">2/10</span>
          </div>
          <div class="gauge-track"><div class="gauge-fill stress" id="gf-stress" style="width:20%"></div></div>
        </div>
      </div>

      <!-- Affaire -->
      <div class="section-block">
        <div class="block-label">Avancement de l'affaire</div>
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
          <div class="affaire-track" style="flex:1;max-width:none;">
            <div class="affaire-fill" id="affaire-fill" style="width:0%"></div>
          </div>
          <div class="affaire-pct" id="affaire-pct">0%</div>
        </div>
        <div id="affaire-desc" style="font-size:0.72rem;color:var(--text-muted);font-style:italic;line-height:1.6;">
          Les dossiers s'accumulent. Quelqu'un ne veut pas que vous trouviez la vérité.
        </div>
      </div>

      <!-- Journal de bord -->
      <div class="section-block" style="flex:1;display:flex;flex-direction:column;">
        <div class="block-label">Journal de bord</div>
        <div id="log"></div>
      </div>
    </div>
  </div>

  <!-- BOTTOM BAR -->
  <div id="bottombar">
    <div class="affaire-bar">
      <div class="affaire-label">Jour</div>
      <div class="day-badge" id="day-bottom">1</div>
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn" onclick="openRulesModal()">Règles</button>
      <button class="btn primary" id="btn-next-day" onclick="nextDay()">Journée suivante →</button>
    </div>
  </div>
</div>

<!-- OVERLAY / MODAL -->
<div id="overlay">
  <div class="modal" id="modal-content"></div>
</div>

<!-- GAME OVER -->
<div id="gameover">
  <div class="go-title">Fin de l'enquête</div>
  <div class="go-reason" id="go-reason"></div>
  <div class="go-stats" id="go-stats"></div>
  <button class="btn primary" onclick="restartGame()">Recommencer</button>
</div>

<!-- WIN -->
<div id="winscreen">
  <div class="win-title">Affaire résolue.</div>
  <div class="go-reason" id="win-reason" style="color:var(--text-secondary)"></div>
  <div class="go-stats" id="win-stats"></div>
  <button class="btn primary" onclick="restartGame()">Nouvelle enquête</button>
</div>

<script>
/* ══════════════════════════════════════════════
   DONNÉES
══════════════════════════════════════════════ */

// ─── LÉGENDE DES TYPES ───────────────────────────────────────────────────────
// rarete : "commun" | "peu_commun" | "rare"
// surreal: true → bordure violette = événement/carte surréaliste (hors réalité)
// temps  : coût en heures sur les 8h de la journée
// cout   : ressources dépensées AVANT l'effet (positif = on perd cette quantité)
// effet  : ce qui change après la carte (positif = gain, sauf stress où positif = mauvais)
// ─────────────────────────────────────────────────────────────────────────────

const CARTES = [

  // ── REPOS ──────────────────────────────────────────────────────────────────
  {
    id:"dormir",
    nom:"Dormir 8h",
    texte:"Une nuit complète. Les cauchemars ont eu la décence d'attendre.",
    type:"repos", temps:8,
    cout:{},
    effet:{energie:+6,moral:+2,stress:-2},
    rarete:"commun"
  },
  {
    id:"dormir_mal",
    nom:"Dormir 4h",
    texte:"Vous vous réveillez plus fatigué qu'avant. Le dossier vous a suivi dans le sommeil.",
    type:"repos", temps:4,
    cout:{},
    effet:{energie:+2,stress:+1},
    rarete:"commun"
  },
  {
    id:"sieste",
    nom:"Sieste au bureau",
    texte:"La tête sur les dossiers. Quelqu'un a posé une veste sur vos épaules.",
    type:"repos", temps:2,
    cout:{},
    effet:{energie:+2,moral:+1},
    rarete:"commun"
  },
  {
    id:"faire_sport",
    nom:"Courir 10km",
    texte:"Vos pensées ne courent pas aussi vite. Pour l'instant.",
    type:"repos", temps:2,
    cout:{energie:2},
    effet:{energie:+2,stress:-3,moral:+1},
    rarete:"commun"
  },
  {
    id:"boire_seul",
    nom:"Boire seul",
    texte:"Le fond du verre ne répond pas. Mais il écoute.",
    type:"repos", temps:3,
    cout:{argent:12},
    effet:{stress:-3,moral:-2,energie:-1},
    rarete:"commun"
  },
  {
    id:"manger_chaud",
    nom:"Manger un vrai repas",
    texte:"Pas un sandwich. Une assiette. Dans un restaurant avec des gens.",
    type:"repos", temps:2,
    cout:{argent:18},
    effet:{energie:+3,moral:+2,stress:-1},
    rarete:"commun"
  },
  {
    id:"prendre_conges",
    nom:"Congé forcé",
    texte:"Le commissaire vous y oblige. Vous obéissez. Pour une fois.",
    type:"repos", temps:8,
    cout:{avancement:-8},
    effet:{energie:+8,moral:+4,stress:-5,relations:+2},
    rarete:"rare"
  },
  {
    id:"meditation",
    nom:"Méditation",
    texte:"Vingt minutes les yeux fermés. La pièce est toujours là quand vous les rouvrez.",
    type:"repos", temps:1,
    cout:{},
    effet:{stress:-2,moral:+1},
    rarete:"commun"
  },
  {
    id:"bain_froid",
    nom:"Douche froide",
    texte:"Ça réveille. Ça ne guérit pas.",
    type:"repos", temps:1,
    cout:{},
    effet:{energie:+3,stress:-1},
    rarete:"commun"
  },

  // ── ENQUÊTE ────────────────────────────────────────────────────────────────
  {
    id:"taper_rapport",
    nom:"Taper un rapport",
    texte:"La bureaucratie avance. L'enquête aussi. Un peu.",
    type:"enquete", temps:3,
    cout:{energie:2},
    effet:{avancement:+7,reputation:+1},
    rarete:"commun"
  },
  {
    id:"interroger_temoin",
    nom:"Interroger un témoin",
    texte:"Ils savent quelque chose. Ils ne vous le diront peut-être pas.",
    type:"enquete", temps:3,
    cout:{energie:3},
    effet:{avancement:+10,stress:+1},
    rarete:"commun"
  },
  {
    id:"fouiller_illegal",
    nom:"Fouille illégale",
    texte:"Vous trouvez ce qu'il faut. Votre badge brille moins fort.",
    type:"enquete", temps:3,
    cout:{energie:2,reputation:-2},
    effet:{avancement:+14,stress:+2},
    rarete:"commun"
  },
  {
    id:"analyser_indices",
    nom:"Analyser les indices",
    texte:"La vérité est là, quelque part. Sous la surface.",
    type:"enquete", temps:4,
    cout:{energie:3},
    effet:{avancement:+16,moral:-1},
    rarete:"peu_commun"
  },
  {
    id:"soudoyer",
    nom:"Soudoyer un informateur",
    texte:"L'argent change de mains dans le noir. L'info aussi.",
    type:"enquete", temps:2,
    cout:{argent:35,reputation:-1},
    effet:{avancement:+18},
    rarete:"peu_commun"
  },
  {
    id:"infiltrer",
    nom:"Infiltrer le milieu",
    texte:"Vous n'êtes plus tout à fait vous-même ce soir.",
    type:"enquete", temps:6,
    cout:{energie:4,moral:-2,stress:+3},
    effet:{avancement:+24,relations:-2},
    rarete:"rare"
  },
  {
    id:"nuit_blanche",
    nom:"Nuit blanche",
    texte:"L'aube vous trouve encore à votre bureau. Vous avancez. Tout le reste recule.",
    type:"enquete", temps:8,
    cout:{energie:5,stress:+4},
    effet:{avancement:+22,moral:-3},
    rarete:"peu_commun"
  },
  {
    id:"surveiller",
    nom:"Surveillance de nuit",
    texte:"Quatre heures dans une voiture froide. Quelque chose finit par bouger.",
    type:"enquete", temps:5,
    cout:{energie:3,stress:+2},
    effet:{avancement:+12,moral:-1},
    rarete:"commun"
  },
  {
    id:"perquisition",
    nom:"Perquisition officielle",
    texte:"Dans les règles. Lent. Mais solide devant un tribunal.",
    type:"enquete", temps:4,
    cout:{energie:3},
    effet:{avancement:+11,reputation:+2},
    rarete:"commun"
  },
  {
    id:"croiser_sources",
    nom:"Croiser les sources",
    texte:"Trois témoignages contradictoires. Un seul peut être vrai. Peut-être aucun.",
    type:"enquete", temps:3,
    cout:{energie:2,stress:+1},
    effet:{avancement:+9,moral:-1},
    rarete:"commun"
  },
  {
    id:"reunion_brigade",
    nom:"Réunion de brigade",
    texte:"Une heure de tableau blanc. Deux nouvelles pistes. Une qui tient.",
    type:"enquete", temps:2,
    cout:{energie:1},
    effet:{avancement:+6,relations:+1},
    rarete:"commun"
  },
  {
    id:"expertise_labo",
    nom:"Expertise labo",
    texte:"Les résultats arrivent. Ils confirment ce que vous espériez ne pas trouver.",
    type:"enquete", temps:3,
    cout:{argent:25},
    effet:{avancement:+15,stress:+1},
    rarete:"peu_commun"
  },
  {
    id:"filature",
    nom:"Filature",
    texte:"Vous le suivez depuis ce matin. Il ne vous a pas vu. Vous croyez.",
    type:"enquete", temps:5,
    cout:{energie:3,stress:+2},
    effet:{avancement:+13,moral:-1},
    rarete:"commun"
  },
  {
    id:"contact_journaliste",
    nom:"Contact journaliste",
    texte:"Un échange d'informations. Vous donnez moins que vous prenez. Cette fois.",
    type:"enquete", temps:2,
    cout:{reputation:-1},
    effet:{avancement:+8,relations:+1},
    rarete:"peu_commun"
  },
  {
    id:"dossier_archive",
    nom:"Dossier d'archives",
    texte:"L'affaire a des précédents. Quelqu'un savait. Avant vous.",
    type:"enquete", temps:3,
    cout:{energie:2},
    effet:{avancement:+10,moral:-1,stress:+1},
    rarete:"commun"
  },

  // ── PERSONNEL / RELATIONS ──────────────────────────────────────────────────
  {
    id:"appeler_famille",
    nom:"Appeler la famille",
    texte:"Leur voix vous rappelle pourquoi vous faites ça.",
    type:"personnel", temps:1,
    cout:{energie:1},
    effet:{moral:+3,relations:+2},
    rarete:"commun"
  },
  {
    id:"parler_collegue",
    nom:"Parler à un collègue",
    texte:"Il comprend. Ce métier ronge tout le monde pareil.",
    type:"personnel", temps:1,
    cout:{energie:1},
    effet:{moral:+2,stress:-1,relations:+1},
    rarete:"commun"
  },
  {
    id:"diner_famille",
    nom:"Dîner en famille",
    texte:"Pour une fois, vous êtes là. Vraiment là. Ils ne savent pas si ça durera.",
    type:"personnel", temps:3,
    cout:{argent:20},
    effet:{moral:+4,relations:+4,stress:-2},
    rarete:"peu_commun"
  },
  {
    id:"lettre_conjoint",
    nom:"Écrire à votre proche",
    texte:"Vous n'envoyez pas la lettre. Mais vous l'avez écrite.",
    type:"personnel", temps:1,
    cout:{},
    effet:{moral:+2,relations:+1},
    rarete:"commun"
  },
  {
    id:"confier_collegue",
    nom:"Se confier",
    texte:"Vous dites plus que prévu. Lui aussi. Rien ne sort de ce bureau.",
    type:"personnel", temps:2,
    cout:{energie:1},
    effet:{moral:+3,stress:-2,relations:+2},
    rarete:"peu_commun"
  },

  // ── SOIN / SANTÉ ───────────────────────────────────────────────────────────
  {
    id:"seance_psy",
    nom:"Séance chez le psy",
    texte:"Elle dit que vous refoulez. Vous acquiescez.",
    type:"soin", temps:2,
    cout:{argent:25,energie:1},
    effet:{moral:+5,stress:-4},
    rarete:"peu_commun"
  },
  {
    id:"cafe_triple",
    nom:"Triple expresso",
    texte:"Votre cœur bat trop vite. Vous verrez ça plus tard.",
    type:"stimulant", temps:1,
    cout:{argent:4},
    effet:{energie:+3,stress:+2},
    rarete:"commun"
  },
  {
    id:"medicaments",
    nom:"Médicaments",
    texte:"Ordonnance ou pas. Ça tient debout. C'est tout ce qui compte.",
    type:"soin", temps:1,
    cout:{argent:15},
    effet:{energie:+3,stress:-2},
    rarete:"peu_commun"
  },
  {
    id:"arret_maladie",
    nom:"Arrêt maladie",
    texte:"Le médecin insiste. Vous résistez. Finalement vous cédez — deux jours.",
    type:"soin", temps:8,
    cout:{avancement:-6,reputation:-1},
    effet:{energie:+7,moral:+3,stress:-5},
    rarete:"rare"
  },

  // ── ADMINISTRATIF / ARGENT ─────────────────────────────────────────────────
  {
    id:"heures_sup",
    nom:"Heures supplémentaires",
    texte:"La prime ne compensera pas. Mais elle paie le loyer.",
    type:"admin", temps:4,
    cout:{energie:3,moral:-1,stress:+2},
    effet:{argent:+40},
    rarete:"commun"
  },
  {
    id:"vendre_info",
    nom:"Vendre une info",
    texte:"À qui, exactement ? Vous préférez ne pas le savoir.",
    type:"admin", temps:1,
    cout:{reputation:-2,moral:-2},
    effet:{argent:+50},
    rarete:"rare"
  },
  {
    id:"note_de_frais",
    nom:"Note de frais",
    texte:"Vous arrondissez les chiffres. Un peu. La comptabilité ne lit jamais vraiment.",
    type:"admin", temps:1,
    cout:{reputation:-1},
    effet:{argent:+20},
    rarete:"peu_commun"
  },

  // ── SURRÉALISTE ────────────────────────────────────────────────────────────
  {
    id:"reve_lucide",
    nom:"Rêve lucide",
    texte:"Dans le rêve, le coupable vous regarde. Vous reconnaissez ses yeux.",
    type:"surréaliste", temps:3,
    cout:{},
    effet:{avancement:+10,moral:-1,stress:+2},
    rarete:"rare", surreal:true
  },
  {
    id:"miroir_inverse",
    nom:"Le miroir se souvient",
    texte:"Votre reflet a deux secondes de retard. Il sait quelque chose.",
    type:"surréaliste", temps:1,
    cout:{moral:-1},
    effet:{avancement:+6,stress:+3},
    rarete:"rare", surreal:true
  },
  {
    id:"lettre_anonyme",
    nom:"Lettre sans expéditeur",
    texte:"Elle n'a pas de timbre. Elle était dans votre poche depuis ce matin.",
    type:"surréaliste", temps:2,
    cout:{stress:+2},
    effet:{avancement:+14,moral:-2},
    rarete:"rare", surreal:true
  },
  {
    id:"double_memoire",
    nom:"Faux souvenir",
    texte:"Vous vous rappelez clairement quelque chose qui ne s'est pas passé. Mais les détails sont vrais.",
    type:"surréaliste", temps:2,
    cout:{moral:-2},
    effet:{avancement:+12,stress:+3},
    rarete:"rare", surreal:true
  },
  {
    id:"voix_radio",
    nom:"Message dans le bruit",
    texte:"Entre deux fréquences, quelqu'un dit votre nom. L'adresse que vous cherchiez depuis une semaine.",
    type:"surréaliste", temps:1,
    cout:{stress:+3},
    effet:{avancement:+16},
    rarete:"rare", surreal:true
  },
  {
    id:"porte_inconnue",
    nom:"La porte du fond",
    texte:"Cette porte n'était pas là hier. Derrière : le bureau de la victime, intact.",
    type:"surréaliste", temps:3,
    cout:{moral:-2,stress:+2},
    effet:{avancement:+18,energie:-1},
    rarete:"rare", surreal:true
  },
];

const EVENEMENTS_QUOTIDIENS = [
  // ── MENACES ──
  {
    id:"menace",
    tag:"Menace",
    type:"lourd",
    texte:"Un suspect glisse une enveloppe sous votre porte. À l'intérieur : une photo de votre enfant. Pas de message.",
    effets:{stress:+4,moral:-2},
    choix:[
      {texte:"Ignorer — garder le cap",effet:{avancement:-5}},
      {texte:"Porter plainte",effet:{avancement:+8,relations:-1,stress:+2}}
    ]
  },
  {
    id:"filature_inverse",
    tag:"Menace",
    type:"lourd",
    texte:"Quelqu'un vous suit depuis trois jours. Vous le voyez enfin. Il ne se cache plus.",
    effets:{stress:+3,moral:-2},
    choix:[
      {texte:"L'affronter",effet:{avancement:+8,stress:+2,reputation:-1}},
      {texte:"Prévenir la hiérarchie",effet:{avancement:+3,reputation:+1}}
    ]
  },
  {
    id:"mise_en_garde",
    tag:"Menace",
    type:"lourd",
    texte:"Un avocat véreux vous remet une « mise en garde à l'amiable ». Douze pages. Votre nom partout.",
    effets:{stress:+3,moral:-2,reputation:-2},
    choix:[
      {texte:"Ignorer",effet:{avancement:+4}},
      {texte:"Consulter un avocat",effet:{argent:-30,reputation:+2}}
    ]
  },

  // ── FAMILLE ──
  {
    id:"enfant_malade",
    tag:"Famille",
    type:"lourd",
    texte:"Votre enfant est malade. L'école vous appelle. L'affaire attend. Votre famille, moins.",
    effets:{moral:-2,stress:+2},
    choix:[
      {texte:"Partir le chercher",effet:{avancement:-8,relations:+5,moral:+3}},
      {texte:"Envoyer quelqu'un d'autre",effet:{avancement:0,relations:-3,moral:-3}}
    ]
  },
  {
    id:"dispute_conjoint",
    tag:"Famille",
    type:"lourd",
    texte:"« Tu es encore en retard. » C'est la troisième fois cette semaine. Le silence qui suit est plus lourd que les mots.",
    effets:{moral:-3,relations:-2,stress:+2},
    choix:[
      {texte:"S'excuser, promettre de changer",effet:{relations:+3,avancement:-5}},
      {texte:"Expliquer l'importance de l'affaire",effet:{relations:-1,avancement:+3}}
    ]
  },
  {
    id:"anniversaire_oublie",
    tag:"Famille",
    type:"lourd",
    texte:"Vous avez oublié l'anniversaire. Encore. Ils n'ont rien dit au dîner. C'est pire.",
    effets:{moral:-4,relations:-3,stress:+2},
    choix:[
      {texte:"Rentrer avec des fleurs",effet:{argent:-20,relations:+3,moral:-1}},
      {texte:"Appeler et s'excuser",effet:{relations:+1,moral:-2}}
    ]
  },
  {
    id:"visite_parents",
    tag:"Famille",
    type:"neutre",
    texte:"Vos parents passent à l'improviste. Ils remarquent les cernes. Ils ne disent rien.",
    effets:{moral:-1,stress:+1},
    choix:[
      {texte:"Passer du temps avec eux",effet:{moral:+3,relations:+2,avancement:-4}},
      {texte:"Prétexte urgent",effet:{moral:-2,relations:-1}}
    ]
  },

  // ── HIÉRARCHIE ──
  {
    id:"pression_hierarchie",
    tag:"Hiérarchie",
    type:"neutre",
    texte:"Le commissaire veut des résultats « cette semaine ». Il tape sur le bureau pour appuyer le mot « semaine ».",
    effets:{stress:+3,moral:-2},
    choix:[
      {texte:"Promettre des résultats",effet:{avancement:+5,stress:+2}},
      {texte:"Expliquer la complexité",effet:{reputation:-1,moral:+1}}
    ]
  },
  {
    id:"prime_refusee",
    tag:"Hiérarchie",
    type:"neutre",
    texte:"Votre supérieur refuse votre demande de prime. « Attendez les résultats. » Les résultats attendent aussi.",
    effets:{moral:-2,stress:+1},
    choix:[
      {texte:"Accepter en silence",effet:{reputation:+1}},
      {texte:"Protester",effet:{reputation:-1,moral:+1}}
    ]
  },
  {
    id:"mutation_proposee",
    tag:"Hiérarchie",
    type:"neutre",
    texte:"On vous propose une mutation. Meilleure ville, meilleur poste. L'affaire resterait ici.",
    effets:{moral:0,stress:+2},
    choix:[
      {texte:"Refuser — terminer l'affaire",effet:{moral:-1,avancement:+5}},
      {texte:"Demander du temps",effet:{reputation:+1,stress:-1}}
    ]
  },
  {
    id:"convocation_igs",
    tag:"Hiérarchie",
    type:"lourd",
    texte:"Convocation à l'IGS. Affaire de corruption. Votre nom cité. Ce n'est pas vous. Pas vraiment.",
    effets:{stress:+4,moral:-3,reputation:-3},
    choix:[
      {texte:"Coopérer pleinement",effet:{reputation:+2,avancement:-6}},
      {texte:"Rester vague",effet:{stress:+2,avancement:+4}}
    ]
  },

  // ── PRESSE / RÉPUTATION ──
  {
    id:"article_presse",
    tag:"Presse",
    type:"lourd",
    texte:"Un journal publie un article vous accusant de corruption. La photo est truquée. Vous n'en êtes pas certain.",
    effets:{reputation:-3,stress:+3,moral:-1},
    choix:[
      {texte:"Droit de réponse",effet:{argent:-20,reputation:+2}},
      {texte:"Ignorer, rester concentré",effet:{avancement:+4}}
    ]
  },
  {
    id:"bonne_presse",
    tag:"Presse",
    type:"positif",
    texte:"Un journaliste écrit un portrait élogieux. Vous n'aimez pas votre photo. Mais ça aide.",
    effets:{reputation:+3,moral:+1},
    choix:[]
  },

  // ── CORPS / SANTÉ ──
  {
    id:"insomnie",
    tag:"Corps",
    type:"physique",
    texte:"Vous n'arrivez pas à dormir. Vous revoyez la scène de crime. Encore. L'heure tourne.",
    effets:{energie:-3,stress:+3},
    choix:[]
  },
  {
    id:"migraine",
    tag:"Corps",
    type:"physique",
    texte:"Migraine depuis ce matin. Les néons du bureau pulsent. Les dossiers bougent.",
    effets:{energie:-2,moral:-1,stress:+2},
    choix:[
      {texte:"Prendre un médicament et continuer",effet:{argent:-10,energie:+1}},
      {texte:"Rentrer se coucher",effet:{avancement:-4,energie:+3,stress:-2}}
    ]
  },
  {
    id:"crise_panique",
    tag:"Corps",
    type:"physique",
    texte:"Dans les toilettes du couloir. Dix minutes. Vous ne savez pas comment vous en êtes sorti.",
    effets:{energie:-2,moral:-3,stress:+3},
    choix:[
      {texte:"Appeler votre psy",effet:{argent:-15,moral:+2,stress:-2}},
      {texte:"Reprendre le travail",effet:{avancement:+4,stress:+2}}
    ]
  },

  // ── INDICES / POSITIFS ──
  {
    id:"temoignage_inattendu",
    tag:"Indice",
    type:"positif",
    texte:"Un inconnu vous aborde dans la rue. Il a vu quelque chose. Ses yeux ne mentent pas.",
    effets:{avancement:+10},
    choix:[]
  },
  {
    id:"aide_inattendue",
    tag:"Allié",
    type:"positif",
    texte:"Un avocat vous contacte. Il a des informations. Pas par bonté d'âme, mais ça suffit.",
    effets:{avancement:+8,relations:+1},
    choix:[]
  },
  {
    id:"soutien_collegue",
    tag:"Quotidien",
    type:"neutre",
    texte:"Un collègue vous pose un café sur le bureau. « T'as l'air crevé. » Vous ne répondez rien.",
    effets:{moral:+1,energie:+1},
    choix:[]
  },
  {
    id:"document_fuite",
    tag:"Indice",
    type:"positif",
    texte:"Un document confidentiel arrive dans votre boîte mail depuis une adresse inconnue. Il est réel.",
    effets:{avancement:+12,stress:+1},
    choix:[
      {texte:"L'exploiter immédiatement",effet:{avancement:+6,reputation:-1}},
      {texte:"Vérifier la source d'abord",effet:{avancement:+3,reputation:+1}}
    ]
  },

  // ── ERREURS / REVERS ──
  {
    id:"faux_suspect",
    tag:"Erreur",
    type:"lourd",
    texte:"Vous avez arrêté la mauvaise personne. Tout le monde le sait maintenant. Vous aussi.",
    effets:{reputation:-4,moral:-3,stress:+3,avancement:-10},
    choix:[]
  },
  {
    id:"preuve_irrecevable",
    tag:"Erreur",
    type:"lourd",
    texte:"La preuve phare est irrecevable. Vice de procédure. Deux semaines de travail s'effondrent.",
    effets:{avancement:-12,moral:-3,stress:+3},
    choix:[
      {texte:"Recommencer proprement",effet:{avancement:+5,energie:-2}},
      {texte:"Trouver un contournement",effet:{avancement:+3,reputation:-2}}
    ]
  },
  {
    id:"temoins_se_retractent",
    tag:"Revers",
    type:"lourd",
    texte:"Deux témoins se rétractent le même jour. Ça ne ressemble pas à une coïncidence.",
    effets:{avancement:-8,moral:-2,stress:+3},
    choix:[
      {texte:"Chercher pourquoi",effet:{avancement:+6,energie:-2,stress:+1}},
      {texte:"Passer aux autres pistes",effet:{avancement:-3}}
    ]
  },
  {
    id:"fuite_dossier",
    tag:"Revers",
    type:"lourd",
    texte:"Des éléments du dossier ont fuité. Quelqu'un à l'intérieur. Vous ne savez pas qui.",
    effets:{avancement:-8,reputation:-3,stress:+4,moral:-2},
    choix:[
      {texte:"Enquêter en interne",effet:{avancement:+5,relations:-2}},
      {texte:"Cloisonner l'information",effet:{avancement:+3,reputation:+1}}
    ]
  },

  // ── ARGENT ──
  {
    id:"facture_inattendue",
    tag:"Finances",
    type:"neutre",
    texte:"Une facture que vous aviez oubliée. Ou repoussée. Le résultat est le même.",
    effets:{argent:-30,moral:-1,stress:+1},
    choix:[]
  },
  {
    id:"remboursement_frais",
    tag:"Finances",
    type:"positif",
    texte:"La comptabilité rembourse trois mois de frais d'un coup. Sans explication.",
    effets:{argent:+45,moral:+1},
    choix:[]
  },

  // ── SURRÉALISTE ──
  {
    id:"ombre_sans_corps",
    tag:"Anomalie",
    type:"surréaliste",
    texte:"Ce matin, votre ombre ne correspond pas à votre position. Elle montre un endroit. Vous reconnaissez la rue.",
    effets:{stress:+2,avancement:+12},
    choix:[
      {texte:"Suivre l'ombre",effet:{avancement:+10,moral:-2,stress:+1}},
      {texte:"L'ignorer",effet:{stress:+2}}
    ], surreal:true
  },
  {
    id:"suspect_futur",
    tag:"Anomalie",
    type:"surréaliste",
    texte:"Le suspect principal vous remercie pour sa libération. Le procès est dans trois mois. Aujourd'hui, il n'a pas encore été arrêté.",
    effets:{stress:+4,moral:-2},
    choix:[
      {texte:"Consigner dans le dossier",effet:{avancement:+6,reputation:-1}},
      {texte:"Ne rien dire",effet:{stress:+3}}
    ], surreal:true
  },
  {
    id:"telephone_absent",
    tag:"Anomalie",
    type:"surréaliste",
    texte:"Vous avez reçu un appel. Votre téléphone était éteint. Le numéro correspond à une personne décédée en 1987.",
    effets:{stress:+3,avancement:+9},
    choix:[
      {texte:"Tenter de rappeler",effet:{moral:-3,avancement:+8}},
      {texte:"Effacer et oublier",effet:{stress:+1,moral:+1}}
    ], surreal:true
  },
  {
    id:"memo_double",
    tag:"Anomalie",
    type:"surréaliste",
    texte:"Vous trouvez un mémo que vous ne vous souvenez pas avoir écrit. Les faits sont exacts. La date : demain.",
    effets:{avancement:+15,moral:-2,stress:+2},
    choix:[], surreal:true
  },
  {
    id:"horloge_arretee",
    tag:"Anomalie",
    type:"surréaliste",
    texte:"Toutes les horloges du commissariat s'arrêtent à la même heure. Celle du meurtre. Personne d'autre ne semble le remarquer.",
    effets:{stress:+3,avancement:+8},
    choix:[
      {texte:"Photographier — noter dans le dossier",effet:{avancement:+6,reputation:-1}},
      {texte:"Garder pour vous",effet:{moral:-2,stress:+1}}
    ], surreal:true
  },
  {
    id:"victime_vivante",
    tag:"Anomalie",
    type:"surréaliste",
    texte:"La victime vous appelle. Sa voix. Son numéro. Elle dit : « Vous brûlez. »",
    effets:{stress:+5,moral:-2,avancement:+14},
    choix:[], surreal:true
  },
];

const EVENEMENTS_LOURDS = [
  {
    id:"disparition_conjoint",
    tag:"Rupture",
    texte:"Votre conjoint a disparu. Son dernier message : « Je ne peux plus vivre avec tes absences. » La chambre est vide. Les clés sont là.",
    effets:{moral:-6,relations:-6,stress:+5}
  },
  {
    id:"menace_directe",
    tag:"Danger",
    texte:"Quelqu'un a taillé deux lettres dans la peinture de votre voiture. « STOP ». La lame était neuve.",
    effets:{stress:+5,moral:-3,reputation:-2}
  },
  {
    id:"effondrement",
    tag:"Santé",
    texte:"Vous vous évanouissez dans le couloir du commissariat. Le médecin dit « épuisement sévère ». Vous retournez au bureau le lendemain.",
    effets:{energie:-7,moral:-3,stress:+4}
  },
  {
    id:"trahison_collegue",
    tag:"Trahison",
    texte:"Votre binôme transmettait des informations à l'ennemi depuis six semaines. Vous ne l'aviez pas vu venir.",
    effets:{moral:-5,reputation:-4,avancement:-18,stress:+5}
  },
  {
    id:"nuit_surreelle",
    tag:"Anomalie",
    texte:"Vous vous réveillez assis à votre bureau. La nuit entière manque. Sur votre bloc-notes : des noms, des adresses, une carte annotée. Vous ne les reconnaissez pas. L'enquête avance pourtant.",
    effets:{avancement:+20,stress:+6,moral:-4},
    surreal:true
  },
  {
    id:"corps_reconnu",
    tag:"Choc",
    texte:"On a retrouvé un corps. Vous connaissez le visage. Pas de la scène de crime — d'ailleurs. De votre vie d'avant.",
    effets:{moral:-6,stress:+5,avancement:+10}
  },
  {
    id:"suspension",
    tag:"Hiérarchie",
    texte:"Suspension provisoire en attendant l'enquête interne. Vous gardez votre badge. Vous n'avez plus le droit de vous en servir.",
    effets:{avancement:-15,reputation:-5,moral:-4,stress:+5}
  },
  {
    id:"incendie_domicile",
    tag:"Danger",
    texte:"Votre appartement a brûlé cette nuit. Le rapport dit « accident ». Personne n'y croit.",
    effets:{argent:-60,moral:-5,stress:+6,relations:-2}
  },
  {
    id:"cible_proche",
    tag:"Danger",
    texte:"Quelqu'un a suivi votre enfant à la sortie de l'école. Personne n'a été blessé. Cette fois.",
    effets:{moral:-6,stress:+6,relations:-3}
  },
  {
    id:"fausse_preuve",
    tag:"Revers",
    texte:"Une pièce à conviction majeure était un faux. Fabriqué de toutes pièces. Vous avez bâti votre enquête dessus.",
    effets:{avancement:-20,moral:-5,reputation:-4,stress:+4}
  },
];

/* ══════════════════════════════════════════════
   ÉTAT DU JEU
══════════════════════════════════════════════ */
let G = {};

function initState() {
  G = {
    energie: 8,    // moins de marge au départ
    moral: 6,
    relations: 6,
    reputation: 7,
    stress: 3,     // on démarre déjà un peu stressé
    avancement: 0,
    argent: 80,    // budget serré
    jour: 1,
    totalJours: 0,
    totalCartes: 0,
    tempsTotal: 8,
    tempsRestant: 8,
    cartesDuJour: [],
    cartesJouees: [],
    eventRepondu: false,
  };
}

/* ══════════════════════════════════════════════
   FONCTIONS UTILITAIRES
══════════════════════════════════════════════ */
function clamp(val, min, max) { return Math.max(min, Math.min(max, val)); }

function appliquerEffets(effets, animate=true) {
  for (const [stat, delta] of Object.entries(effets)) {
    if (G[stat] === undefined) continue;
    const before = G[stat];
    G[stat] += delta;
    if (stat === 'stress') G[stat] = Math.max(0, G[stat]);
    else if (stat === 'argent') G[stat] = Math.max(0, G[stat]);
    else if (stat === 'avancement') G[stat] = clamp(G[stat], 0, 100);
    else G[stat] = clamp(G[stat], 0, 10);
    if (animate && G[stat] !== before) {
      const isGood = G[stat] > before;
      flashGauge(stat, isGood);
    }
  }
  majUI();
  verifierFin();
}

function flashGauge(stat, good) {
  const el = document.getElementById(`g-${stat}`);
  if (!el) return;
  el.classList.remove('flash-red','flash-gold');
  void el.offsetWidth;
  el.classList.add(good ? 'flash-gold' : 'flash-red');
  setTimeout(()=>el.classList.remove('flash-red','flash-gold'), 700);
}

function addLog(msg, type='system') {
  const log = document.getElementById('log');
  const entry = document.createElement('div');
  entry.className = `log-entry ${type}`;
  entry.textContent = `J.${G.jour} — ${msg}`;
  log.appendChild(entry);
  log.scrollTop = log.scrollHeight;
  while(log.children.length > 40) log.removeChild(log.firstChild);
}

function majTemps() {
  const slots = document.getElementById('time-slots');
  const rem = document.getElementById('time-remaining');
  const msg = document.getElementById('time-exhausted-msg');
  if (!slots) return;

  slots.innerHTML = '';
  for (let i = 0; i < G.tempsTotal; i++) {
    const s = document.createElement('div');
    s.className = 'time-slot';
    if (i >= G.tempsRestant) {
      s.classList.add('used');
    } else {
      const pct = G.tempsRestant / G.tempsTotal;
      if (pct <= 0.25) s.classList.add('danger-slot');
      else if (pct <= 0.5) s.classList.add('warn');
      else s.classList.add('active');
    }
    slots.appendChild(s);
  }

  rem.textContent = `${G.tempsRestant}h restante${G.tempsRestant > 1 ? 's' : ''}`;
  const pct = G.tempsRestant / G.tempsTotal;
  rem.className = `time-remaining ${pct <= 0.25 ? 'danger' : pct <= 0.5 ? 'warn' : ''}`;

  if (G.tempsRestant <= 0) {
    msg.style.display = 'block';
    // Griser toutes les cartes non jouées
    document.querySelectorAll('.action-card:not(.played)').forEach(el => {
      el.style.opacity = '0.25';
      el.style.pointerEvents = 'none';
    });
  } else {
    msg.style.display = 'none';
    // Griser cartes trop chères en temps
    document.querySelectorAll('.action-card:not(.played)').forEach(el => {
      const id = el.id.replace('acard-', '');
      const carte = G.cartesDuJour.find(c => c.id === id);
      if (carte && carte.temps > G.tempsRestant) {
        el.style.opacity = '0.3';
        el.style.pointerEvents = 'none';
        el.title = `Pas assez de temps (${carte.temps}h nécessaires)`;
      } else if (carte) {
        el.style.opacity = '';
        el.style.pointerEvents = '';
        el.title = '';
      }
    });
  }
}

function majUI() {
  // Top stats
  const statNames = ['energie','moral','relations','reputation','stress','argent'];
  for (const s of statNames) {
    const el = document.getElementById(`ui-${s}`);
    if (!el) continue;
    if (s === 'argent') {
      el.textContent = `${G.argent}€`;
      el.className = `stat-val ${G.argent > 80 ? 'good' : G.argent > 30 ? 'warn' : 'danger'}`;
    } else {
      el.textContent = G[s];
      const v = G[s];
      let cls = '';
      if (s === 'stress') cls = v >= 8 ? 'surreal' : v >= 5 ? 'warn' : 'good';
      else cls = v <= 2 ? 'danger' : v <= 4 ? 'warn' : 'good';
      el.className = `stat-val ${cls}`;
    }
  }
  document.getElementById('ui-day').textContent = `Jour ${G.jour}`;
  document.getElementById('day-bottom').textContent = G.jour;

  // Gauges
  const gauges = ['energie','moral','relations','reputation','stress'];
  for (const s of gauges) {
    const fill = document.getElementById(`gf-${s}`);
    const val = document.getElementById(`gv-${s}`);
    if (!fill || !val) continue;
    const pct = (G[s] / 10) * 100;
    fill.style.width = pct + '%';
    val.textContent = `${G[s]}/10`;
    fill.classList.remove('low','mid');
    if (s === 'stress') {
      if (G[s] >= 8) fill.classList.add('low');
      else if (G[s] >= 5) fill.classList.add('mid');
    } else {
      if (G[s] <= 2) fill.classList.add('low');
      else if (G[s] <= 4) fill.classList.add('mid');
    }
  }

  // Avancement
  document.getElementById('affaire-fill').style.width = G.avancement + '%';
  document.getElementById('affaire-pct').textContent = G.avancement + '%';

  // Desc affaire
  const descs = [
    "Les dossiers s'accumulent. Quelqu'un ne veut pas que vous trouviez la vérité.",
    "Des fils commencent à apparaître. Vous tirez doucement.",
    "Les connexions se précisent. L'enquête prend forme.",
    "Vous approchez. Les menaces se font plus directes.",
    "La vérité est à portée. Mais à quel prix ?",
  ];
  const idx = Math.min(Math.floor(G.avancement / 20), 4);
  document.getElementById('affaire-desc').textContent = descs[idx];

  majTemps();
}

/* ══════════════════════════════════════════════
   LOGIQUE JOURNÉE
══════════════════════════════════════════════ */
function nouvelleJournee() {
  G.cartesJouees = [];
  G.eventRepondu = false;
  G.tempsRestant = G.tempsTotal;
  document.getElementById('played-label').style.display = 'none';
  document.getElementById('played-area').innerHTML = '';
  document.getElementById('time-exhausted-msg').style.display = 'none';

  majUI();

  // Piocher 4 cartes aléatoires
  const shuffled = [...CARTES].sort(() => Math.random() - 0.5);
  G.cartesDuJour = shuffled.slice(0, 4);

  // Choisir un événement
  let pool;
  if (G.jour % 10 === 0) {
    pool = EVENEMENTS_LOURDS;
    document.getElementById('phase-num').textContent = '⚠ Phase Critique';
    document.getElementById('phase-title').textContent = 'Événement grave';
  } else {
    pool = EVENEMENTS_QUOTIDIENS;
    document.getElementById('phase-num').textContent = `Phase ${G.jour}`;
    document.getElementById('phase-title').textContent = 'Événement du jour';
  }

  const event = pool[Math.floor(Math.random() * pool.length)];
  afficherEvenement(event);
  afficherCartes();
  majUI();
}

function afficherEvenement(event) {
  const area = document.getElementById('event-area');
  const isSurreal = event.surreal;
  const isLourd = event.type === 'lourd' || EVENEMENTS_LOURDS.includes(event);
  const tagCls = isSurreal ? 'surreal' : isLourd ? 'heavy' : '';
  const cardCls = isSurreal ? 'surreal' : isLourd ? 'heavy' : '';

  // Build effets pills
  const effetsHtml = Object.entries(event.effets || {}).map(([k,v]) => {
    const nom = {energie:'Énergie',moral:'Moral',relations:'Relations',reputation:'Réputation',stress:'Stress',avancement:'Enquête',argent:'Argent'}[k] || k;
    const cls = v > 0 ? (k==='stress'?'neg':'pos') : (k==='stress'?'pos':'neg');
    const sign = v > 0 ? '+' : '';
    return `<span class="effect-pill ${cls}">${nom} ${sign}${v}</span>`;
  }).join('');

  // Apply immediate (non-choice) effects
  if (event.effets) appliquerEffets(event.effets);

  // Choix
  let choixHtml = '';
  if (event.choix && event.choix.length > 0) {
    choixHtml = '<div class="event-choices">';
    event.choix.forEach((c, i) => {
      const effStr = JSON.stringify(c.effet).replace(/"/g,"'");
      choixHtml += `<button class="btn-choice" id="choice-btn-${i}" onclick="choisirOption(${i}, ${effStr.replace(/'/g,'"')}, this)">${c.texte}</button>`;
    });
    choixHtml += '</div>';
  }

  const logType = isSurreal ? 'surreal' : isLourd ? 'failure' : 'system';
  addLog(`"${event.texte.substring(0,60)}..."`, logType);

  const surealEvtBadge = isSurreal ? `<div class="surreal-badge" style="margin-top:10px;" data-tip="Anomalie surréaliste : cet événement défie la logique du réel. Pas d'explication rationnelle — vos choix ont quand même des conséquences.">◈ Anomalie</div>` : '';

  area.innerHTML = `
    <div class="event-card ${cardCls}" style="animation-delay:0ms">
      <div class="event-tag ${tagCls}">${event.tag || 'Événement'}</div>
      <div class="event-text">${event.texte}</div>
      <div class="event-effects">${effetsHtml}</div>
      ${choixHtml}
      ${surealEvtBadge}
    </div>
  `;

  if (!event.choix || event.choix.length === 0) G.eventRepondu = true;
}

function choisirOption(idx, effet, btn) {
  if (G.eventRepondu) return;
  G.eventRepondu = true;
  document.querySelectorAll('.btn-choice').forEach(b => {
    b.classList.add('acted');
    b.onclick = null;
  });
  btn.style.borderColor = 'var(--accent-dim)';
  btn.style.color = 'var(--accent)';
  appliquerEffets(effet);
  addLog(`Choix : « ${btn.textContent} »`, 'system');
}

function afficherCartes() {
  // Helpers pour générer les chips par stat
  const STAT_META = {
    energie:    { label:'Énergie',    icon:'⚡', cls:'chip-energie' },
    moral:      { label:'Moral',      icon:'◎',  cls:'chip-moral' },
    relations:  { label:'Relations',  icon:'♡',  cls:'chip-relations' },
    reputation: { label:'Réputation', icon:'★',  cls:'chip-reputation' },
    stress:     { label:'Stress',     icon:'⚠',  cls:'chip-stress' },
    argent:     { label:'Argent',     icon:'€',  cls:'chip-argent' },
    avancement: { label:'Enquête',    icon:'◈',  cls:'chip-avancement' },
  };

  function makeChip(stat, val, isCost) {
    const meta = STAT_META[stat];
    if (!meta) return '';
    // Pour le stress : positif = mauvais, négatif = bon
    const isGood = stat === 'stress' ? val < 0 : val > 0;
    const sign = val > 0 ? '+' : '';
    const signClass = isGood ? 'gain' : 'loss';
    const arrow = isGood ? '▲' : '▼';
    return `<span class="chip ${meta.cls} ${signClass}" title="${meta.label} ${sign}${val}">${meta.icon} <span class="chip-sign">${arrow}</span>${Math.abs(val)}</span>`;
  }

  const area = document.getElementById('cards-area');
  area.innerHTML = G.cartesDuJour.map((carte, i) => {
    const isSurreal = carte.surreal;
    const tooExpensive = carte.temps > G.tempsRestant;

    // Chip temps
    const tempsChip = `<span class="chip chip-temps" title="Durée : ${carte.temps}h">⏱ ${carte.temps}h</span>`;

    // Chips coûts (ce qu'on perd en jouant la carte)
    const coutsChips = Object.entries(carte.cout)
      .filter(([,v]) => v !== 0)
      .map(([k, v]) => {
        // cout positif = on perd cette ressource
        const delta = typeof v === 'number' && v > 0 ? -v : v;
        return makeChip(k, delta, true);
      }).join('');

    // Chips effets
    const effChips = Object.entries(carte.effet)
      .filter(([,v]) => v !== 0)
      .map(([k, v]) => makeChip(k, v, false))
      .join('');

    const rarLabel = carte.rarete === 'rare' ? '◆' : carte.rarete === 'peu_commun' ? '◇' : '';
    const rarCls = carte.rarete === 'rare' ? 'rare' : '';
    const surealBadge = carte.surreal ? `<div class="surreal-badge" data-tip="Cette carte échappe à la logique ordinaire. Ses effets peuvent sembler irrationnels — faites confiance à votre instinct, pas à la raison.">◈ Anomalie</div>` : '';
    const opacStyle = tooExpensive ? 'opacity:0.3;pointer-events:none;' : '';
    const titleAttr = tooExpensive ? `title="Pas assez de temps (${carte.temps}h nécessaires)"` : '';

    return `<div class="action-card ${isSurreal?'surreal':''}" style="animation-delay:${i*60}ms;${opacStyle}" ${titleAttr} onclick="jouerCarte('${carte.id}',this)" id="acard-${carte.id}">
      ${rarLabel ? `<div class="card-rarete ${rarCls}">${rarLabel}</div>` : ''}
      <div class="card-name">${carte.nom}</div>
      <div class="card-text">${carte.texte}</div>
      <div class="card-costs">${tempsChip}${coutsChips}</div>
      <div class="card-effects">${effChips}</div>
      ${surealBadge}
    </div>`;
  }).join('');
}

function jouerCarte(id, el) {
  if (el.classList.contains('played')) return;
  if (G.tempsRestant <= 0) {
    addLog('Plus de temps aujourd\'hui.', 'warn');
    return;
  }
  const carte = CARTES.find(c=>c.id===id);
  if (!carte) return;

  // Vérifier temps disponible
  if (carte.temps > G.tempsRestant) {
    addLog(`Pas assez de temps pour « ${carte.nom} » (${carte.temps}h nécessaires, ${G.tempsRestant}h restantes).`, 'warn');
    return;
  }

  // Vérifier coûts ressources
  for (const [stat, cout] of Object.entries(carte.cout)) {
    if (cout < 0) continue;
    if (G[stat] !== undefined && G[stat] < cout) {
      addLog(`Impossible : pas assez de ${stat}.`, 'warn');
      return;
    }
  }

  // Consommer le temps
  G.tempsRestant -= carte.temps;

  // Appliquer coûts
  const coutsFinal = {};
  for (const [stat, val] of Object.entries(carte.cout)) {
    if (val > 0) coutsFinal[stat] = -val;
  }
  appliquerEffets(coutsFinal, false);
  appliquerEffets(carte.effet);

  el.classList.add('played');
  G.cartesJouees.push(carte);
  G.totalCartes++;

  addLog(`[${carte.temps}h] « ${carte.nom} »`, carte.surreal ? 'surreal' : 'success');

  // Move to played zone
  const playedArea = document.getElementById('played-area');
  document.getElementById('played-label').style.display = 'flex';
  const mini = document.createElement('div');
  mini.className = 'action-card played';
  mini.style.opacity = '0.4';
  mini.innerHTML = `<div class="card-name">${carte.nom}</div><div class="card-text" style="font-size:0.6rem;">${carte.temps}h utilisées</div>`;
  playedArea.appendChild(mini);

  // Refresh time display (majTemps is called via majUI via appliquerEffets)
  majTemps();
}

function nextDay() {
  G.jour++;
  G.totalJours = G.jour;

  // Dépenses quotidiennes
  const loyer = 15;  // plus cher
  const depenses = {argent: -loyer};
  appliquerEffets(depenses, false);

  // Accumulation naturelle de stress chaque jour
  const usure = {stress: +1};
  appliquerEffets(usure, false);

  // Perte d'énergie naturelle si pas dormi
  if (G.cartesJouees.filter(c => c.type === 'repos').length === 0) {
    appliquerEffets({energie: -1}, false);
  }

  majUI();
  nouvelleJournee();
  addLog(`— Jour ${G.jour} commence. Loyer : -${loyer}€`, 'system');
}

/* ══════════════════════════════════════════════
   VÉRIF FIN DE JEU
══════════════════════════════════════════════ */
function verifierFin() {
  if (G.avancement >= 100) {
    setTimeout(()=>{
      afficherVictoire();
    }, 600);
    return;
  }
  const reasons = [];
  if (G.energie <= 0) reasons.push("Effondrement physique total. Votre corps a rendu les armes avant votre esprit.");
  if (G.moral <= 0) reasons.push("Burn-out sévère. Vous n'avez plus la force de tenir debout, encore moins de chercher la vérité.");
  if (G.relations <= 0) reasons.push("Votre famille est partie. Il ne reste que le dossier et le silence.");
  if (G.stress >= 10) reasons.push("La pression a eu raison de vous. Une nuit, vous avez simplement disparu.");
  if (G.argent <= 0 && G.jour > 5) reasons.push("Ruiné. Vous ne pouvez plus payer votre loyer, ni votre silence.");

  if (reasons.length > 0) {
    setTimeout(()=>{
      afficherGameOver(reasons[0]);
    }, 400);
  }
}

function afficherGameOver(reason) {
  const go = document.getElementById('gameover');
  document.getElementById('go-reason').textContent = reason;
  document.getElementById('go-stats').innerHTML = `
    <div class="result-row"><span class="result-label">Jours tenus</span><span class="result-val">${G.totalJours}</span></div>
    <div class="result-row"><span class="result-label">Avancement</span><span class="result-val ${G.avancement>50?'good':'bad'}">${G.avancement}%</span></div>
    <div class="result-row"><span class="result-label">Cartes jouées</span><span class="result-val">${G.totalCartes}</span></div>
    <div class="result-row"><span class="result-label">Réputation finale</span><span class="result-val">${G.reputation}/10</span></div>
  `;
  go.classList.add('active');
}

function afficherVictoire() {
  const win = document.getElementById('winscreen');

  const endings = [
    {min:0, max:3, text:"L'affaire est résolue. Votre famille ne l'est pas. Dans le couloir du tribunal, vous cherchez un visage familier. Il n'y en a aucun."},
    {min:4, max:6, text:"Vous avez résolu l'affaire. À quel prix ? Vous comptez les pertes. Certaines ne se comptent pas."},
    {min:7, max:10, text:"L'affaire est classée. Votre nom sera peut-être mentionné. Vous, vous regardez par la fenêtre et vous pensez à autre chose."},
  ];
  const moral = G.moral;
  const ending = endings.find(e => moral >= e.min && moral <= e.max) || endings[1];

  document.getElementById('win-reason').textContent = ending.text;
  document.getElementById('win-stats').innerHTML = `
    <div class="result-row"><span class="result-label">Jours d'enquête</span><span class="result-val">${G.totalJours}</span></div>
    <div class="result-row"><span class="result-label">Moral final</span><span class="result-val ${G.moral>6?'good':G.moral>3?'':'bad'}">${G.moral}/10</span></div>
    <div class="result-row"><span class="result-label">Relations</span><span class="result-val ${G.relations>5?'good':'bad'}">${G.relations}/10</span></div>
    <div class="result-row"><span class="result-label">Réputation</span><span class="result-val">${G.reputation}/10</span></div>
    <div class="result-row"><span class="result-label">Argent restant</span><span class="result-val">${G.argent}€</span></div>
  `;
  win.classList.add('active');
}

/* ══════════════════════════════════════════════
   MODAL RÈGLES
══════════════════════════════════════════════ */
function openRulesModal() {
  const modal = document.getElementById('modal-content');
  modal.innerHTML = `
    <div class="modal-title">Règles du jeu</div>
    <div class="modal-sub">Double Jeu — Guide de survie</div>
    <div class="modal-body">
      <strong>Objectif</strong><br>
      Faire avancer l'enquête à 100% avant de vous effondrer. Chaque journée vous coûte des ressources. Chaque choix laisse des traces.
      <br><br>
      <strong>Le temps — la ressource centrale</strong><br>
      Vous disposez de <strong>8 heures par jour</strong>, affichées en haut des cartes. Chaque action en consomme un certain nombre — de 1h (un café) à 7h (une nuit blanche). Les cartes que vous ne pouvez plus vous permettre en temps s'assombrissent. Choisissez avec soin : vous ne pourrez pas tout faire.
      <br><br>
      <strong>Ressources</strong><br>
      Vous gérez 6 jauges : Énergie, Moral, Relations, Réputation, Stress et Argent. Si l'Énergie, le Moral ou les Relations tombent à 0, c'est la fin. Si le Stress atteint 10, c'est la fin.
      <br><br>
      <strong>Chaque jour</strong><br>
      Un événement arrive — vous pouvez parfois choisir comment réagir. Quatre cartes-actions sont proposées. Quand vous n'avez plus de temps ou que vous avez fait vos choix, passez à la journée suivante.
      <br><br>
      <strong>Tous les 10 jours</strong><br>
      Un événement grave se déclenche. Préparez-vous.
      <br><br>
      <strong>Fins multiples</strong><br>
      Si vous gagnez, la fin dépend de votre Moral final. Le sacrifice a un coût narratif.
    </div>
    <button class="btn primary" onclick="closeModal()">Fermer</button>
  `;
  document.getElementById('overlay').classList.add('active');
}

function closeModal() {
  document.getElementById('overlay').classList.remove('active');
}

/* ══════════════════════════════════════════════
   DÉMARRAGE
══════════════════════════════════════════════ */
function startGame() {
  const ss = document.getElementById('start-screen');
  ss.classList.add('fade-out');
  setTimeout(()=>{
    ss.classList.add('hidden');
    document.getElementById('game').style.display = 'grid';
    initState();
    majUI();
    nouvelleJournee();
    addLog('Enquête ouverte. Bonne chance.', 'system');
  }, 650);
}

function restartGame() {
  document.getElementById('gameover').classList.remove('active');
  document.getElementById('winscreen').classList.remove('active');
  initState();
  majUI();
  nouvelleJournee();
  addLog('Nouvelle enquête. Encore.', 'system');
}

document.addEventListener('DOMContentLoaded', function() {
  const overlay = document.getElementById('overlay');
  if (overlay) {
    overlay.addEventListener('click', function(e){
      if(e.target === this) closeModal();
    });
  }
});
</script>
</body>
</html>
